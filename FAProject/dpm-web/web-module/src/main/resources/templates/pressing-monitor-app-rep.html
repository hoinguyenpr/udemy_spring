<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
	th:replace="~{layouts/main-layout :: main-fragment(
	                                          ~{:: title},
	                                          ~{:: #css-page},
	                                          ~{:: #custom-css-page},
	                                          ~{:: #navbar},
	                                          ~{:: #main-content},  
	                                          ~{:: #footer},
	                                          ~{:: #custom-js}
	                                         )}">

<head>

<title>Pressing Monitor Approve Report</title>

<!-- partial:layouts/otherStaticResources.html -->
<th:block id="css-page" th:replace="~{layouts/mainCss}"></th:block>

<!-- Custom CSS for this page in here -->
<th:block id="custom-css-page">

	<!-- start link cdn css -->
	<link rel="stylesheet"
		href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
	<link rel="stylesheet"
		href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css">
	<!-- end link cdn css -->

	<style>
.content-wrapper {
	max-width: 95%;
}

.table-responsive {
	height: 400px;
}

.form-check {
	border: solid black;
}

.form-check-input {
	position: relative;
	margin: 0 auto;
}
</style>

</th:block>
<!-- End Custom CSS  -->

</head>

<body>
	<div class="container-scroller">

		<!-- partial:layouts/navbar.html -->
		<th:block id="navbar" th:replace="layouts/navbar"></th:block>

		<th:block id="main-content">
			<!-- Copy From start to here-->

			<div class="container-fluid page-body-wrapper">
				<div class="main-panel">
					<div class="content-wrapper">
						<div class="row">
							<div class="col-12">
								<div class="card">
									<div class="card-header bg-white pt-4">
										<p class="h3">[[#{pressing-monitor.report.title}]]</p>
									</div>
									<div class="card-body">
										<div class="row mt-4">
											<div class="col-md-12">
												<!-- Start of FIELDSET 3-->
												<fieldset class="border p-2">

													<legend class="w-auto h6 text-muted p-2">
														[[#{pressing-monitor.report.form.legend}]] </legend>

													<!-- start row 1 -->
													<div class="form-group row">

														<div class="col-md-5 col-sm-12">
															<div class="row">
																<label for="createEmployee"
																	class="col-md-4 col-sm-4 col-form-label"
																	th:utext="#{pressing-monitor.report.form.start-date}">
																</label> <input type="date"
																	class="form-control col-md-8 col-sm-8 myTime"
																	id="startInputDate" required>
															</div>
														</div>

														<div class="col-md-2 col-sm-12"></div>

														<div class="col-md-5 col-sm-12">
															<div class="row">
																<label class="col-md-4 col-sm-4 col-form-label"
																	th:utext="#{pressing-monitor.report.form.end-date}">
																</label> <input type="date"
																	class="form-control col-md-8 col-sm-8"
																	id="endInputDate" required>
															</div>
														</div>

													</div>
													<!-- end row 1 -->

													<!-- start row 2 -->
													<div class="form-group row">

														<div class="col-md-5 col-sm-12">
															<div class="row">
																<label class="col-md-4 col-sm-4 col-form-label">
																	Trạng thái </label> <select
																	class="form-control col-md-8 col-sm-8"
																	id="filterStatus">
																	<option value="-1">Tất cả</option>
																	<option value="0">Chờ duyệt</option>
																	<option value="1">Đã duyệt</option>
																	<option value="2">Từ chối duyệt</option>
																</select>
															</div>
														</div>

														<div class="col-md-2 col-sm-12"></div>


														<div class="col-5"></div>
													</div>
													<!-- end row 2 -->

												</fieldset>
												<!-- End of FIELDSET-->
											</div>
										</div>
										<div class="row justify-content-end">
											<div class="col-md-2 col-sm-12">
												<button class="btn btn-sm btn-info col-md-12 mt-3"
													type="button" onclick="submitForm()">
													[[#{pressing-monitor.report.from.button}]]</button>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>


						<div class="row mt-3">
							<div class="col-12">
								<div class="card">
									<div class="card-header bg-white pt-4">
										<p class="h3">Danh sách</p>
									</div>

									<div class="card-body">

										<!-- start config view -->
										<div class="row d-flex justify-content-end">

											<div class="col-md-2 col-sm-12 mr-3">
												<button class="btn btn-primary btn-block">
													<i class="fas fa-cog"></i> Cài đặt hiển thị
												</button>
											</div>

											<div class="col-md-2 col-sm-12">
												<select class="form-control row" id="setSize"
													onchange="submitForm()">
													<option value="5">Hiển thị 5 dòng</option>
													<option value="10">Hiển thị 10 dòng</option>
													<option value="20">Hiển thị 20 dòng</option>
												</select>
											</div>
										</div>
										<!-- end config view -->

										<!-- start table -->
										<div class="table-responsive mt-3">
											<table
												class="table table-striped text-center table-bordered mt-0"
												id="record-table">
												<thead>
													<tr role="row">

														<th scope="col" colspan="2">#</th>

														<th scope="col">
															<div class="btn-group"
																th:unless="${listPms == null || listPms.isEmpty()}">
																<button type="button" class="btn btn-primary"
																	id="btnApproveAll" onclick="approveAll()">
																	Approve All</button>
																<button type="button"
																	class="btn btn-primary dropdown-toggle dropdown-toggle-split"
																	id="dropupMenu" data-toggle="dropdown"
																	aria-haspopup="true" aria-expanded="false"></button>
																<div class="dropdown-menu" aria-labelledby="dropupMenu">

																	<button class="dropdown-item" id="btnRefuseAll"
																		onclick="refuseAll()">Refuse all</button>

																	<button class="dropdown-item" id="btnExportExcel"
																		onclick="downloadExcel()">Export to excel</button>

																	<button class="dropdown-item" type="button"
																		onclick="checkAll()">Check all</button>

																	<button class="dropdown-item" type="button"
																		onclick="unCheckAll()">Uncheck all</button>
																</div>
															</div>
														</th>
														<th scope="col"
															th:utext="#{pressing-monitor.table.column.lot-code}"></th>
														<th scope="col"
															th:utext="#{pressing-monitor.table.type-product}"></th>
														<th scope="col"
															th:utext="#{pressing-monitor.table.input-time}"></th>
														<th scope="col"
															th:utext="#{pressing-monitor.table.weight}"></th>
														<th scope="col"
															th:utext="#{pressing-monitor.table.net-status}"></th>
														<th scope="col"
															th:utext="#{pressing-monitor.table.pressure}"></th>
														<th th:utext="#{pressing-monitor.table.weight-milk}"></th>
														<th scope="col"
															th:utext="#{pressing-monitor.table.residue}"></th>
														<th scope="col">
															[[#{pressing-monitor.table.create-person}]]</th>
														<th scope="col">[[#{pressing-monitor.table.status}]]
														</th>
														<th scope="col">[[#{pressing-monitor.table.note}]]</th>
													</tr>
												</thead>
												<tbody>

													<tr th:if="${listPms == null || listPms.isEmpty()}">
														<td colspan="14">
															[[#{pressing-monitor.table.no-data}]]</td>
													</tr>

													<th:block
														th:unless="${listPms == null || listPms.isEmpty()}">

														<tr th:each="pm, i : ${listPms}">
															<td><label class="form-check-label"> <input
																	type="checkbox" class="form-check-input check-elements"
																	th:value="${pm.id}"> <i class="input-helper"></i>
															</label></td>
															<td>[[${i.index + 1}]]</td>
															<td>
																<button type="button"
																	class="btn btn-primary w-75 bg-danger"
																	th:if="${pm.status == 1}"
																	th:attr="onclick=|refuse(${pm.id})|">
																	<i class="far fa-times-circle" style="color: #ffffff;"
																		title="Không duyệt"></i>
																</button>

																<div class="btn-group w-75" role="group"
																	aria-label="Basic example" th:if="${pm.status == 0}">
																	<button type="button" class="btn btn-primary w-50"
																		th:attr="onclick=|approve(${pm.id})|">
																		<i class="fas fa-eye" style="color: #ffffff;"
																			title="Duyệt"></i>
																	</button>
																	<button type="button" class="btn btn-primary w-50"
																		th:attr="onclick=|refuse(${pm.id})|">
																		<i class="far fa-times-circle" style="color: #ffffff;"
																			title="Không duyệt"></i>
																	</button>
																</div>

																<button type="button"
																	class="btn btn-primary w-75 bg-success"
																	th:if="${pm.status == 2}"
																	th:attr="onclick=|approve(${pm.id})|">
																	<i class="fas fa-eye" style="color: #ffffff;"
																		title="Duyệt"></i>
																</button>
															</td>
															<td th:text="${pm.ingredientBatch.ingredientBatchCode}"></td>
															<td th:text="${pm.typeProduct.typeProductName}"></td>

															<td>[[${#temporals.format(pm.getInputTime(),
																'yyyy-MM-dd HH:mm')}]]</td>

															<td th:text="${pm.weight}"></td>

															<td>
																<div th:if="${pm.netStatusBeforePress}"
																	class="badge badge-success">
																	[[#{pressing-monitor.table.label.ok}]]</div>

																<div th:unless="${pm.netStatusBeforePress}"
																	class="badge badge-danger">
																	[[#{pressing-monitor.table.lable.ng}]]</div>
															</td>
															<td>

																<div th:if="${pm.pressureCondition}"
																	class="badge badge-success">
																	[[#{pressing-monitor.table.label.ok}]]</div>

																<div th:unless="${pm.pressureCondition}"
																	class="badge badge-danger">
																	[[#{pressing-monitor.table.lable.ng}]]</div>

															</td>

															<td th:text="${pm.weightCoconutMilk}"></td>
															<td th:text="${pm.weightResidue}"></td>
															<td th:text="${pm.createEmployee.username}"></td>

															<td th:switch="${pm.status}">
																<div th:case="0">
																	<i class="fas fa-eye-slash" style="color: #ff922b;"
																		title="Chờ duyệt"></i>
																</div>
																<div th:case="1">
																	<i class="fas fa-eye" style="color: #51cf66;"
																		title="Đã duyệt"></i>
																</div>
																<div th:case="2">
																	<i class="far fa-times-circle" style="color: #ff6b6b;"
																		title="Không duyệt"></i>
																</div>
															</td>
															<td th:text="${pm.note}"></td>
														</tr>

													</th:block>
												</tbody>
											</table>
										</div>
										<!-- end table -->

										<!-- start PAGINATIONS -->

										<nav class="mt-3">
										
											<ul class="pagination rounded float-right" th:unless="${listPms.isEmpty()}">
											
												<li class="page-item" th:attr="class = ${listPms.hasPrevious()} ? 'page-item' : 'page-item disabled'">
													<button class="page-link" 
														th:attr="onclick=|submitFilter(0)|">
														<i class="fas fa-angle-double-left"></i>
													</button>
												</li>
											
												<li class="" th:attr="class = ${listPms.hasPrevious()} ? 'page-item' : 'page-item disabled'">
													<button class="page-link"
														th:attr="onclick=|submitFilter(${page - 1})|">
														<i class="fas fa-angle-left"></i>
													</button>
												</li>
												<th:block
													th:each="i: ${#numbers.sequence(0, totalPages - 1)}">

													<li class=""
														th:attr="class = ${page == i} ? 'page-item active' : 'page-item' ">
														<button class="page-link"
															th:attr="onclick=|submitFilter(${i})|">[[${i + 1}]]</button>
													</li>
												</th:block>
												<li class=""
													th:attr="class = ${listPms.hasNext()} ? 'page-item' : 'page-item disabled'">
													<button class="page-link"
														th:attr="onclick=|submitFilter(${page + 1})|">
														<i class="fas fa-angle-right"></i>
													</button>
												</li>
												
												<li th:attr="class = ${listPms.hasNext()} ? 'page-item' : 'page-item disabled'">
													<button class="page-link" th:attr="onclick=|submitFilter(${totalPages - 1})|">
														<i class="fas fa-angle-double-right"></i>
													</button>
												</li>
												
											</ul>
										</nav>

										<!-- end PAGINATIONS -->

									</div>
								</div>
							</div>
						</div>

					</div>
				</div>
			</div>

			<form th:action="@{rep-app}" name="filterForm">
				<input type="hidden" name="page" id="page" value="0"> <input
					type="hidden" name="size" id="size"> <input type="hidden"
					name="start" id="start"> <input type="hidden" name="end"
					id="end"> <input type="hidden" name="status" id="status">
				<input type="hidden" disabled name="ids" id="ids">
			</form>

			<!-- Copy from here to end-->
		</th:block>
	</div>

	<!-- partial:layouts/footer.html -->
	<th:block id="footer" th:replace="layouts/footer"></th:block>

	<!-- Custom JavaScript for this page in here -->
	<th:block id="custom-js">

		<script src="//cdn.jsdelivr.net/npm/sweetalert2@10"></script>

		<script th:inline="javascript">
		
		$(document).ready(()=>{
			$('#startInputDate, #start').val([[${start}]]);
			$('#endInputDate, #end').val([[${end}]]);
			$('#filterStatus, #status').val([[${status}]]);
			$('#setSize, #size').val([[${size}]])
			$('#page').val([[${page}]])
		})
		
		$(document).ready(() => {
			let state = [[${state}]]
			switch (state) {
				case 'APPROVE_SUCCESS':
					showSuccessPositionDialog('Approve row(s) success');
					break;
					
				case 'APPROVE_FAILED':
					showErrorPositionDialog('Approve row(s) failed');
					break;
					
				case 'REFUSE_SUCCESS':
					showSuccessPositionDialog('Refuse row(s) success');
					break;
					
				case 'REFUSE_FAILED':
					showErrorPositionDialog('Refuse row(s) failed');
					break;
					
				default:
					break;
			}
		})
		
		function getDateToString(date = new Date()){
			let str = date.toISOString();
			return str.substr(0, str.indexOf('T'));
		}
		
		function submitForm(action = null, method = null){
			
			if(action !== null) {
				$('form[name="filterForm"]').attr('action', action);
				$('#ids').prop('disabled', false)
			} else {
				$('form[name="filterForm"]').attr('action', '/pressing-monitor/rep-app');
				$('#ids').prop('disabled', true)
			}
			
			if(method !== null)
				$('form[name="filterForm"]').attr('method', method);
			else
				$('form[name="filterForm"]').attr('method', 'GET');
			
			$('#start').val($('#startInputDate').val());
			$('#end').val($('#endInputDate').val());
			$('#status').val($('#filterStatus').val());
			$('#size').val($('#setSize').val());
			
			if($('#status').val() === '-1'){
				$('#status').prop('disabled', true);
			} else {
				$('#status').prop('disabled', false);
			}

			$('form[name="filterForm"]').submit();
		}
		
		function approveAll(){
			
			if(!isCheckLeastOneRow()){
				showErrorPositionDialog("Vui lòng chọn ít nhất 1 dòng");
				return;
			}
			
			confirmDialog("Bạn có chắc duyệt tất cả").then((result) => {
				
			  	if (result.isConfirmed) {
			  		setValueFromChecked();
					submitForm('/pressing-monitor/approve', 'POST');
			  	}
			})
			
		}
		
		function approve(id){
			$('#ids').val(id);
			submitForm('/pressing-monitor/approve', 'POST');
		}
		
		function refuseAll(){
			
			if(!isCheckLeastOneRow()){
				showErrorPositionDialog("Vui lòng chọn ít nhất 1 dòng");
				return;
			}
			
			confirmDialog("Bạn có chắc không duyệt tất cả").then((result) => {
				
			  	if (result.isConfirmed) {
					setValueFromChecked();
					submitForm('/pressing-monitor/refuse', 'POST');
			  	}
			})
		}
		
		function refuse(id){
			$('#ids').val(id);
			submitForm('/pressing-monitor/refuse', 'POST');
		}
		
		function checkAll(){
			$('input.check-elements:unchecked').each((index, ele) => {
				$(ele).prop("checked", true);
			})
		}
		
		function unCheckAll(){
			$('input.check-elements:checked').each((index, ele) => {
				$(ele).prop("checked", false);
			})
		}
		
		function changePage(page){
			$('#ids').prop('disabled', true);
			submitForm();
		}
		
		function isCheckLeastOneRow() {
			return ($('input.check-elements:checked').length !== 0)
		}
		
		function setValueFromChecked(){
			let arr = new Array();
			
			if(isCheckLeastOneRow()){
				$('input.check-elements:checked').each((index, ele) => {
					arr.push($(ele).val())
				})
				
				$('#ids').val(arr);
			}
			
		}
		
		function downloadExcel(){
			let start = $('#startInputDate').val();
			let end = $('#endInputDate').val();
			let status = $('#filterStatus').val();
			window.location.href = '/pressing-monitor/report/download?start='+ start +'&end='+ end +'&status='+status;
		}
		
		function showSuccessPositionDialog(title){
			showPositionDialog(title, 'top-end', 'success');
		}
		
		function showErrorPositionDialog(title){
			showPositionDialog(title, 'top-end', 'error');
		}
		
		function showPositionDialog(title, position = 'top-end', icon = 'success'){
			Swal.fire({
				showClass: {
				    popup: 'animate__animated animate__fadeInDown'
				  },
				  hideClass: {
				    popup: 'animate__animated animate__fadeOutUp'
				  },
				  position: position,
				  icon: icon,
				  title: title,
				  showConfirmButton: false,
				  timer: 1500
				})
		}
		
		function confirmDialog(message){
			const swalWithBootstrapButtons = Swal.mixin({
				  customClass: {
				    confirmButton: 'btn btn-success mx-2',
				    cancelButton: 'btn btn-danger mx-2'
				  },
				  buttonsStyling: false
				})

			return swalWithBootstrapButtons.fire({
			  title: 'Are you sure?',
			  text: message,
			  icon: 'warning',
			  showCancelButton: true,
			  confirmButtonText: 'Yes, delete it!',
			  cancelButtonText: 'No, cancel!',
			  reverseButtons: true
			})
		}
		
		function submitFilter(page){
			$('#page').val(page);
			submitForm();
		}
		
	</script>

	</th:block>
	<!-- End Custom JavaScript  -->

</body>

</html>